units:
  rotation: -17.5
  pcb_y: 165
  pcb_x: 310
  touchpad_x: 110
  touchpad_y: 40
  separation_x: 144
  offset_y: -5



points:
  # defines the spacing of the keys
  key:
    padding: U # cy

  zones:
    grid:
      # grid_1_1 should serve as the origin point of the whole keyboard
      columns:
        0: {}
        1: {}
      rows:
        0: {}
        1: {}

    matrix:
      anchor:
        ref: grid_1_1
        shift: [-separation_x, 3]
        rotate: rotation
      mirror: &mirror
        ref: grid_1_1
        shift: [-0.5U, 0] # necessary when only 2 columns in grid
      columns:
        0: { key: { stagger: 0U, column_net: COL0, mirror.column_net: COL11 } }
        1: { key: { stagger: 0U, column_net: COL1, mirror.column_net: COL10 } }
        2: { key: { stagger: 0.61U, column_net: COL2, mirror.column_net: COL9 } }
        3: { key: { stagger: 0.33U, column_net: COL3, mirror.column_net: COL8 } }
        4: { key: { stagger: -0.33U, column_net: COL4, mirror.column_net: COL7 }}
        5: { key: { stagger: -0.14U, column_net: COL5, mirror.column_net: COL6 }}
      rows:
        0: { row_net: ROW3, mirror.row_net: ROW3 }
        1: { row_net: ROW2, mirror.row_net: ROW2 }
        2: { row_net: ROW1, mirror.row_net: ROW1 }
        3: { row_net: ROW0, mirror.row_net: ROW0 }
    line:
      mirror: *mirror
      anchor: 
        ref: matrix_0_0
        shift: [0.3U, -1.4U]
        rotate: -rotation
      columns:
        0: { key: { column_net: COL0, mirror.column_net: COL11 } }
        1: { key: { column_net: COL1, mirror.column_net: COL10 } }
        2: { key: { column_net: COL2, mirror.column_net: COL9 } }
        3: { key: { column_net: COL3, mirror.column_net: COL8 } }
      rows:
        0: { row_net: ROW4, mirror.row_net: ROW4 }
    cluster:
      mirror: *mirror
      anchor:
        ref: line_3_0
        shift: [32, -13]
        rotate: rotation - 10
      columns:
        0:
          key: { stagger: 0 }
          rows:
            0: { column_net: COL0, mirror.column_net: COL11, row_net: ROW5, mirror.row_net: ROW5 }
        1:
          key: { stagger: -0.5U }
          rows:
            0: { column_net: COL1, mirror.column_net: COL10, row_net: ROW5, mirror.row_net: ROW5 }
            1: { column_net: COL2, mirror.column_net: COL9, row_net: ROW5, mirror.row_net: ROW5 }
        2:
          key: { stagger: -0.5U }
          rows:
            0: { column_net: COL3, mirror.column_net: COL8, row_net: ROW5, mirror.row_net: ROW5 }
            1: { column_net: COL4, mirror.column_net: COL7, row_net: ROW5, mirror.row_net: ROW5 }
              

outlines:
  pcb:
    - what: rectangle
      size: [pcb_x, pcb_y]
      where:
        - ref: grid_1_1
          shift: [-0.5U, offset_y]
  rest: 
    - what: rectangle
      size: [pcb_x, touchpad_y]
      where:
        - ref: grid_1_1
          shift: [-0.5U, offset_y -pcb_y/2 - touchpad_y/2]
  touchpad:
    - what: rectangle
      size: [touchpad_x, touchpad_y]
      where:
        - ref: grid_1_1
          shift: [-0.5U, offset_y -pcb_y/2 - touchpad_y/2]

  base:
    - "+pcb"
    - what: rectangle
      size: [pcb_x, touchpad_y]
      where:
        - ref: grid_1_1
          shift: [-0.5U, offset_y -pcb_y/2 - touchpad_y/2]
    - what: rectangle
      size: [touchpad_x, touchpad_y]
      where:
        - ref: grid_1_1
          # have to shift down by 0.01 microns to cut off the border
          shift: [-0.5U, offset_y -pcb_y/2 - touchpad_y/2- 1e-5]
      operation: subtract
  flanges: 
    - what: rectangle
      where: true
      size: [15, 15]
      bevel: 0
  nicenano:
    - what: rectangle
      size: [19,32]
      where:
        - ref: grid_1_1
          shift: [ -0.5U, 57]
  battery:
    - what: rectangle
      size: [50, 50]
      asym: both
      where:
        - ref: line_0_0
          shift: [30, -50]
  thickplate:
    - "+base"
    - "-battery"
    - "-flanges"
    - "-nicenano"
  switches:
    - what: rectangle
      where: true
      size: [13.9, 13.9]
      bevel: 0
  thinplate:
    - "+base"
    - "-battery"
    - "-switches"
    - "-nicenano"
  keys:
    - what: rectangle
      where: true
      size: [1cx, 1cy] # choc keycaps
      # size: [U-1, U-1] # mx keycaps
      bevel: 0.5
  cover:
    - "+base"
    # subtract keycap outlines + clearance
    - what: rectangle
      operation: subtract
      where: true
      size: U+3 # from centre of key, used for both width/height
      bevel: 2
  combined:
  #   - "^pcb"
    - "^keys"
    #- "^switches"
    #- "^plate"
    # - "^cover"
    - "^nicenano"
    # - "^battery"
    - "^base"
  pcb_large: 
  - "+base"
  - "-battery"



pcbs:
  0: # just a handle,
    template: kicad8
    outlines:
      edge:
        outline: pcb_large
        layer: Edge.Cuts
    footprints:
      # I am using choc v1
      choc:
        what: ceoloide/switch_choc_v1_v2
        where: true
        params:
          from: "{{colrow}}"
          to: "{{column_net}}"
          choc_v2_support: false

          # have to flip the switch 180deg to change option
          solder: true
          hotswap: true

          # just renders outline in kicad
          include_keycap: false
          keycap_width: 17.5
          keycap_height: 16.5

      diodes:
        what: diode
        where: true
        adjust:
          rotate: 0
          shift: [0, +0.5U] # putting between the keys
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"

      mcu:
        what: promicro
        asym: source
        where:
          - ref: grid_1_1
            shift: [ -0.5U, 57]
            rotate: 270
        params:
          orientation: down
          GND: GND
          RAW: RAW
          VCC: VCC
          RST: RST

          P0: ROW1
          P1: ROW0
          P2: ROW2
          P3: ROW3
          P4: ROW4
          P5: ROW5
          P6: COL11
          P7: COL10
          P8: COL9
          P9: COL8
          P10: COL7
          P14: COL5
          P15: COL4
          P16: COL6
          P18: COL3
          P19: COL2
          P20: COL1
          P21: COL0

      reset:
        what: button
        asym: source
        where: 
          - ref: grid_1_1
            shift: [ -0.75U, 45]
            rotate: 180
        params: { from: RST, to: GND }
      batt_jst:
        what: jstph
        asym: source
        where: 
          - ref: line_0_0
            shift: [30, -50]
        params: { side: B, pos: BAT+, neg: GND }
      # power:
      #   what: slider
      #   asym: source
      #   where: { ref: matrix_inner_upper, shift: [60, 30], affect: [x, y] }
      #   params: { side: B, from: BAT+, to: RAW }
      pwr_in:
        what: pad
        asym: source
        where: 
          - ref: line_0_0
            shift: [30, -40]
        params:
          {
            width: 7,
            height: 4,
            front: true,
            back: false,
            net: BAT+,
            text: "+BAT",
          }
      pwr_out:
        what: pad
        asym: source
        where: 
          - ref: line_0_0
            shift: [30, -50]
        params:
          {
            width: 7,
            height: 4,
            front: true,
            back: false,
            net: RAW,
          }

      pwr_out_via:
        what: via
        asym: source
        where: 
          - ref: line_0_0
            shift: [30, -55]
        params: { net: RAW }
